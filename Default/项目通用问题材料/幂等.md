
# 幂等

---
## 参考文章

过滤筛选得出：
* 并发编程网文[数据重复插入](https://ifeve.com/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%95%B0%E6%8D%AE%E9%87%8D%E5%A4%8D%E6%8F%92%E5%85%A5%EF%BC%9F/)，讲了**单库唯一键**和**分库分布式锁**锁住幂等条件
* 知乎某文章，内容不咋地，文章架构还行。
  * 文章架构：系统架构背景和场景概述，幂等概念介绍，CRUD操作中的幂等，解决方案。
  
* 知乎文章 [高并发接口幂等设计](https://zhuanlan.zhihu.com/p/92880181)：
  * 架构：背景，概念，方案，总结
  * 概述：表单重复提交，重复扣款，推送消息，订单重复提交
* 其它

---
## 总结

1.单库单表的解决方案：根据业务建立唯一键
  * 优点
  * 局限
  * 
2.分库分表（分布式）场景：分库分表第三方锁
  * 1


---
## 输出文章

【如何讲好CRUD（一）】：幂等

* 文章架构构思：
  * 背景:
  系统在复杂的【网络环境】和【不可控的人为操作因素】下，往往会产生重复操作的场景。为保障【系统整体的健壮】，我们会要求相关操作结果无论受到多少次重复调用，也都返回相同的响应结果。
  
  * 幂等介绍
    * 名词解释：幂等源自于数学，如f(x)=f(f(x))，后用作计算机概念，表示相同参数多次调用依旧返回相同结果。最简单的幂等有常数函数如f(x)=2，无论多少次调用，函数结果都是2。这类比翻译成计算机程序就是常见的select操作（排除复合操作的场景：两次select中有一次修改。即便出现该场景，业务逻辑上也认为第重复操作的select满足幂等，后续的select重复操作也都只会返回最新结果。）。
    * 具体要求幂等场景：
       * 表单流程提交：由于网络抖动响应延迟等原因导致流程表单提交按钮无响应，用户重复请求可能会导致同一张流程多次发起。
        * 订单支付扣款：类似的，同一份订单用户重复请求支付导致多次付款，不保证幂等客服感觉要被CALL到怀疑人生了。
        * 消息广播推送 ：给一万个客户推送一条大促的广告，推送程序异常导致重复推送，同一条信息在同一个用户的手机端重复刷屏。客户嫌烦直接把你软件给卸载了。
        * 消息消费：分布式系统上下游模块利用消息通讯，数据流转也要求幂等，避免消息中间件或者上游系统模块导致的消息重复下发问题。
        * 并发库存超卖：并发控制没做好导致同一时间1库存卖给了n个客户，
  
  * 解决方案 结合场景
    * 状态机幂等：【OA提交流程】等类似单据问题可以使用**状态机幂等**方案。同一张单据号在同一个操作界面只会产生一个【单据状态】。如果状态机已然处理下一个状态，后台接口收到上一个状态的变更，理论上是不允许实际的数据层操作变动的。
    * 读后写：消息推送被重复触发，每次触发都去**检验**（读）客户机appid是否已经收到推送flag，是的话不触发。否则才进行推送（写）
    * DB唯一索引:无论同个应用进程里多线程触发重复操作还是分布式部署的多个应用进程触发重复操作，保证里DB唯一性约束后就能保证程序应用无法重复插入数据。但要求业务应用逻辑实现对应的DuplicateKeyException的友好处理。
    * token申请机制：请求前约束，同一个请求表单页面只会请求申领一个token,后端页面只会处理一次token。假设网络延迟表单无响应，多次点击提交请求，所携带参数还是之前的token，后端是不会重复处理失效token的请求的。
    * 锁机制：使用乐观锁或者悲观锁保障不会出现并发重复提交的问题。
    * 幂等接口调用：第三方提供幂等接口，允许传入来源和序列号。相同系统来源和业务序列号标示一个唯一请求，多次发送同一请求，第三方系统也只会处理一次。
  * 收尾总结
    * 无论是锁/索引/读后写/token/幂等api的来源与序列号，本质都是保证业务唯一“票据”在并发重复操作中可以被识别，区别在于使用场景和实现方式。
      * 并发不高情况下可以视情况select then insert，加锁。
      * 并发高时使用source+seq等方向进行限流只处理其中的有效请求。
      * 系统交互不复杂的时候可以使用token申领或者db索引限制的方式。
* 文章素材收集：
  * 无
* 文章撰写结果：

---
## 关联项目

报销系统的支付模块。状态机异步控制付款流转节点，下游提供支付接口会根据唯一